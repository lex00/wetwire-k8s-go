name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build
        run: go build ./...

      - name: Test
        run: |
          # Exclude cmd and examples packages from coverage (empty main stubs cause coverage tool errors)
          go test -coverprofile=coverage.out -covermode=atomic $(go list ./... | grep -v '/cmd/' | grep -v '/examples/')
        env:
          SKIP_KIRO_TESTS: "1"

      - name: Upload coverage report
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: lex00/wetwire-k8s-go
          files: coverage.out
          fail_ci_if_error: false

      - name: Round-trip Tests
        run: |
          if [ -d "./internal/importer" ]; then
            go test -v -timeout 10m ./internal/importer/ -run TestRoundTrip
          else
            echo "Skipping round-trip tests: internal/importer not yet implemented"
          fi
