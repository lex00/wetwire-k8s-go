<picture>
  <source media="(prefers-color-scheme: dark)" srcset="./wetwire-dark.svg">
  <img src="./wetwire-light.svg" width="100" height="67">
</picture>

This document explains the code generation infrastructure used in wetwire-k8s-go and how to regenerate resource types when updating to new Kubernetes versions.

## Overview

wetwire-k8s-go uses the official `k8s.io/api` types from the Kubernetes project. These types are already code-generated by the Kubernetes team from OpenAPI schemas. This document covers:

- How Kubernetes generates API types
- How wetwire-k8s-go uses these types
- Understanding the generated code structure
- When and how to update to new Kubernetes versions

## Kubernetes API Type Generation

### Official k8s.io/api Types

wetwire-k8s-go uses unmodified types from `k8s.io/api`:

```go
import (
    appsv1 "k8s.io/api/apps/v1"
    corev1 "k8s.io/api/core/v1"
    networkingv1 "k8s.io/api/networking/v1"
    // ... other API packages
)
```

These types are generated by the Kubernetes project using:

1. **OpenAPI schemas** - Define resource structures
2. **deepcopy-gen** - Generate DeepCopy methods
3. **conversion-gen** - Generate version conversion
4. **defaulter-gen** - Generate default value functions

### Package Structure

The `k8s.io/api` repository is organized by API group and version:

```
k8s.io/api/
├── apps/
│   ├── v1/              # apps/v1 (Deployments, StatefulSets, etc.)
│   ├── v1beta1/         # Legacy beta versions
│   └── v1beta2/
├── core/
│   └── v1/              # core/v1 (Pods, Services, ConfigMaps, etc.)
├── batch/
│   ├── v1/              # batch/v1 (Jobs, CronJobs)
│   └── v1beta1/
├── networking/
│   └── v1/              # networking.k8s.io/v1 (Ingress, NetworkPolicy)
├── rbac/
│   └── v1/              # rbac.authorization.k8s.io/v1 (Roles, RoleBindings)
├── storage/
│   └── v1/              # storage.k8s.io/v1 (StorageClass, VolumeAttachment)
├── policy/
│   └── v1/              # policy/v1 (PodDisruptionBudget)
└── autoscaling/
    ├── v1/              # autoscaling/v1 (HorizontalPodAutoscaler)
    └── v2/              # autoscaling/v2 (HPA with advanced metrics)
```

## How wetwire-k8s-go Uses Generated Types

### Direct Usage

wetwire-k8s-go imports and uses k8s.io/api types directly:

```go
package main

import (
    appsv1 "k8s.io/api/apps/v1"
    corev1 "k8s.io/api/core/v1"
    metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
)

var MyDeployment = &appsv1.Deployment{
    TypeMeta: metav1.TypeMeta{
        APIVersion: "apps/v1",
        Kind:       "Deployment",
    },
    ObjectMeta: metav1.ObjectMeta{
        Name: "myapp",
    },
    Spec: appsv1.DeploymentSpec{
        // ... spec fields
    },
}
```

### Discovery Process

The wetwire-k8s builder discovers resources by:

1. **Parsing Go source** - Uses `go/parser` and `go/ast`
2. **Identifying Kubernetes types** - Checks import paths
3. **Extracting resource declarations** - Finds top-level `var` statements
4. **Building dependency graph** - Tracks field references

See [INTERNALS.md](INTERNALS.md) for detailed architecture.

## Generated Code Structure

### Resource Type Anatomy

Each Kubernetes resource type has this structure:

```go
// TypeMeta describes the type and API version
type Deployment struct {
    metav1.TypeMeta `json:",inline"`

    // ObjectMeta has metadata like name, namespace, labels
    metav1.ObjectMeta `json:"metadata,omitempty"`

    // Spec defines the desired state
    Spec DeploymentSpec `json:"spec,omitempty"`

    // Status represents the current state (usually ignored in manifests)
    Status DeploymentStatus `json:"status,omitempty"`
}
```

### Common Metadata Types

All resources embed `metav1.ObjectMeta`:

```go
type ObjectMeta struct {
    Name                       string            `json:"name,omitempty"`
    Namespace                  string            `json:"namespace,omitempty"`
    Labels                     map[string]string `json:"labels,omitempty"`
    Annotations                map[string]string `json:"annotations,omitempty"`
    UID                        types.UID         `json:"uid,omitempty"`
    ResourceVersion            string            `json:"resourceVersion,omitempty"`
    Generation                 int64             `json:"generation,omitempty"`
    CreationTimestamp          Time              `json:"creationTimestamp,omitempty"`
    DeletionTimestamp          *Time             `json:"deletionTimestamp,omitempty"`
    DeletionGracePeriodSeconds *int64            `json:"deletionGracePeriodSeconds,omitempty"`
    Finalizers                 []string          `json:"finalizers,omitempty"`
    OwnerReferences            []OwnerReference  `json:"ownerReferences,omitempty"`
    // ...
}
```

### Pointer Fields

Many fields use pointers to distinguish between "not set" and "zero value":

```go
type DeploymentSpec struct {
    // Replicas is a pointer - nil means "not specified"
    Replicas *int32 `json:"replicas,omitempty"`

    // Selector is a pointer
    Selector *metav1.LabelSelector `json:"selector"`

    // Template is not a pointer (required field)
    Template corev1.PodTemplateSpec `json:"template"`
}
```

Helper function for creating pointers:

```go
func ptr[T any](v T) *T { return &v }

// Usage
Replicas: ptr(int32(3))
```

### JSON Tags

All fields have JSON tags that control serialization:

```go
type Container struct {
    Name  string `json:"name"`                  // Required, no omitempty
    Image string `json:"image"`                 // Required
    Ports []ContainerPort `json:"ports,omitempty"` // Optional
}
```

The `omitempty` tag means the field is omitted from JSON/YAML if it's zero-valued.

## Updating to New Kubernetes Versions

### When to Update

Update k8s.io/api when:

- New Kubernetes version is released
- New resource types are needed
- New fields are added to existing types
- Bug fixes in type definitions

### Update Process

1. **Check compatibility** - Verify k8s.io/api version supports your target Kubernetes version

2. **Update dependencies:**

```bash
# Update to specific version
go get k8s.io/api@v0.30.0
go get k8s.io/apimachinery@v0.30.0

# Or update to latest
go get k8s.io/api@latest
go get k8s.io/apimachinery@latest
```

3. **Update go.mod:**

```bash
go mod tidy
```

4. **Test compatibility:**

```bash
# Run all tests
go test ./...

# Build examples
cd examples/guestbook && wetwire-k8s build
cd ../web-service && wetwire-k8s build
cd ../configmap-secret && wetwire-k8s build
```

5. **Update documentation** if new types or fields are relevant

### Version Compatibility Matrix

| Kubernetes Version | k8s.io/api Version | Go Version |
|-------------------|-------------------|------------|
| 1.28.x | v0.28.x | 1.20+ |
| 1.29.x | v0.29.x | 1.21+ |
| 1.30.x | v0.30.x | 1.21+ |
| 1.31.x | v0.31.x | 1.22+ |

The k8s.io/api version should match your target Kubernetes cluster version.

## Understanding Generated Resources

### Core Resources (corev1)

```go
import corev1 "k8s.io/api/core/v1"

// Available types:
// - Pod, PodTemplate
// - Service, Endpoints, EndpointSlice
// - ConfigMap, Secret
// - PersistentVolume, PersistentVolumeClaim
// - Namespace, Node
// - ServiceAccount
// - ResourceQuota, LimitRange
```

### Apps Resources (appsv1)

```go
import appsv1 "k8s.io/api/apps/v1"

// Available types:
// - Deployment
// - StatefulSet
// - DaemonSet
// - ReplicaSet
// - ControllerRevision
```

### Batch Resources (batchv1)

```go
import batchv1 "k8s.io/api/batch/v1"

// Available types:
// - Job
// - CronJob
```

### Networking Resources (networkingv1)

```go
import networkingv1 "k8s.io/api/networking/v1"

// Available types:
// - Ingress, IngressClass
// - NetworkPolicy
```

### RBAC Resources (rbacv1)

```go
import rbacv1 "k8s.io/api/rbac/v1"

// Available types:
// - Role, RoleBinding
// - ClusterRole, ClusterRoleBinding
```

### Storage Resources (storagev1)

```go
import storagev1 "k8s.io/api/storage/v1"

// Available types:
// - StorageClass
// - CSIDriver, CSINode
// - VolumeAttachment
```

### Policy Resources (policyv1)

```go
import policyv1 "k8s.io/api/policy/v1"

// Available types:
// - PodDisruptionBudget
```

### Autoscaling Resources (autoscalingv2)

```go
import autoscalingv2 "k8s.io/api/autoscaling/v2"

// Available types:
// - HorizontalPodAutoscaler
```

## Custom Resource Definitions (CRDs)

For custom resources not in k8s.io/api, use unstructured types:

```go
import "k8s.io/apimachinery/pkg/apis/meta/v1/unstructured"

var MyCustomResource = &unstructured.Unstructured{
    Object: map[string]interface{}{
        "apiVersion": "example.com/v1",
        "kind":       "MyResource",
        "metadata": map[string]interface{}{
            "name":      "my-resource",
            "namespace": "default",
        },
        "spec": map[string]interface{}{
            "field1": "value1",
            "field2": 42,
        },
    },
}
```

Or generate typed clients using controller-gen:

```bash
# Install controller-gen
go install sigs.k8s.io/controller-tools/cmd/controller-gen@latest

# Generate types from CRD
controller-gen object:headerFile=hack/boilerplate.go.txt paths=./api/...
```

## Code Generation Tools

### deepcopy-gen

Generates `DeepCopy` methods for all types:

```go
// Generated code
func (in *Deployment) DeepCopy() *Deployment {
    if in == nil {
        return nil
    }
    out := new(Deployment)
    in.DeepCopyInto(out)
    return out
}
```

Usage in wetwire-k8s-go:

```go
// Create a copy of a resource
deploymentCopy := MyDeployment.DeepCopy()
deploymentCopy.Spec.Replicas = ptr(int32(5))
```

### conversion-gen

Generates conversion between API versions (e.g., v1beta1 to v1):

```go
// Generated code
func Convert_v1beta1_Deployment_To_v1_Deployment(in *v1beta1.Deployment, out *v1.Deployment, s conversion.Scope) error {
    // Conversion logic
}
```

wetwire-k8s-go doesn't use version conversion directly, but benefits from stable v1 types.

### defaulter-gen

Generates default value functions:

```go
// Generated code
func SetDefaults_Pod(obj *corev1.Pod) {
    if obj.Spec.RestartPolicy == "" {
        obj.Spec.RestartPolicy = corev1.RestartPolicyAlways
    }
}
```

wetwire-k8s-go relies on Kubernetes API server to apply defaults.

## Advanced Topics

### Discovering Available Types

List all types in a package:

```bash
go doc k8s.io/api/apps/v1
```

View specific type:

```bash
go doc k8s.io/api/apps/v1.Deployment
go doc k8s.io/api/apps/v1.DeploymentSpec
```

### Type Compatibility

When updating k8s.io/api versions:

- **Additive changes** - New fields added (backwards compatible)
- **Deprecations** - Old fields marked deprecated but still work
- **Removals** - Rare, usually in beta-to-GA transitions

Check CHANGELOG.md in k8s.io/api for breaking changes.

### Validation Rules

Some types include validation markers:

```go
type DeploymentSpec struct {
    // +kubebuilder:validation:Minimum=0
    Replicas *int32 `json:"replicas,omitempty"`
}
```

These are used by admission webhooks, not enforced at compile-time.

## Best Practices

1. **Pin k8s.io/api versions** - Use exact versions in go.mod
2. **Match cluster version** - Use k8s.io/api version matching your cluster
3. **Test after updates** - Run full test suite after updating
4. **Review changelogs** - Check for breaking changes before updating
5. **Use stable versions** - Prefer v1 over beta/alpha APIs
6. **Avoid deprecated fields** - Check deprecation notices

## Troubleshooting

### Import Errors After Update

**Error:** `package k8s.io/api/apps/v1: no Go files`

**Solution:** Run `go mod tidy` and verify network access to download modules.

### Type Not Found

**Error:** `undefined: SomeNewType`

**Solution:** Check if the type exists in your k8s.io/api version:

```bash
go doc k8s.io/api/apps/v1.SomeNewType
```

Update to a newer version if needed.

### Version Mismatch

**Error:** Build succeeds but validation fails

**Solution:** Ensure k8s.io/api version matches your target Kubernetes version.

## References

- [k8s.io/api Repository](https://github.com/kubernetes/api)
- [k8s.io/apimachinery Repository](https://github.com/kubernetes/apimachinery)
- [Kubernetes API Conventions](https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md)
- [Kubernetes Code Generation](https://github.com/kubernetes/code-generator)

## Next Steps

- See [DEVELOPERS.md](DEVELOPERS.md) for development setup
- Read [INTERNALS.md](INTERNALS.md) for architecture details
- Check [VERSIONING.md](VERSIONING.md) for version compatibility
